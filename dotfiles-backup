#!/bin/bash
# Directories
DOTFILES_DIR="$HOME/hyprland_dotfiles"
CONFIG_DIR="$HOME/.config"

# Check if dotfiles directory exists
if [ ! -d "$DOTFILES_DIR" ]; then
    echo "âŒ Error: $DOTFILES_DIR not found"
    exit 1
fi

cd "$DOTFILES_DIR" || exit 1

echo "ğŸ“¦ Syncing configs to dotfiles repo..."

# Copy configs
rsync -av --delete "$CONFIG_DIR/hypr/" "$DOTFILES_DIR/hypr/"
rsync -av --delete "$CONFIG_DIR/waybar/" "$DOTFILES_DIR/waybar/"
rsync -av --delete "$CONFIG_DIR/alacritty/" "$DOTFILES_DIR/alacritty/"

# Only copy VS Code if it exists
if [ -d "$CONFIG_DIR/Code/User" ]; then
    rsync -av --delete "$CONFIG_DIR/Code/User/settings.json" "$DOTFILES_DIR/Code/settings.json" 2>/dev/null
    rsync -av --delete "$CONFIG_DIR/Code/User/keybindings.json" "$DOTFILES_DIR/Code/keybindings.json" 2>/dev/null
fi

# Only copy mimeapps if not the same file
if [ "$CONFIG_DIR/mimeapps.list" != "$DOTFILES_DIR/mimeapps.list" ]; then
    cp "$CONFIG_DIR/mimeapps.list" "$DOTFILES_DIR/mimeapps.list" 2>/dev/null
fi

# Update package lists
pacman -Qqe > "$DOTFILES_DIR/pkglist.txt"
pacman -Qqem > "$DOTFILES_DIR/pkglist-aur.txt"

echo "âœ… Configs synced"
echo ""

# Check for changes
if git diff-index --quiet HEAD --; then
    echo "â„¹ï¸  No changes to commit"
    exit 0
fi

# Show changes
echo "ğŸ“‹ Changes:"
git status --short
echo ""

# Prompt for commit message
echo "Enter commit message (or 'q' to quit):"
read commit_message

if [ "$commit_message" = "q" ]; then
    echo "âŒ Aborted"
    exit 0
fi

if [ -z "$commit_message" ]; then
    echo "âŒ Error: Commit message cannot be empty"
    exit 1
fi

# Git workflow
git add .

if ! git commit -m "$commit_message"; then
    echo "âŒ Commit failed"
    exit 1
fi

echo "ğŸš€ Pushing to GitHub..."
if git push origin main; then
    echo "âœ… Successfully pushed to GitHub!"
else
    echo "âŒ Push failed"
    exit 1
fi
